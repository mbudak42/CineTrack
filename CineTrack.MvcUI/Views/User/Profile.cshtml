@model CineTrack.MvcUI.Models.UserProfileViewModel
@{
	ViewData["Title"] = Model.User.Username + " Profili";
}

<div class="container py-4">
	<div class="card shadow-sm mb-4">
		<div class="card-body">
			<div class="row align-items-center">
				<div class="col-md-2 text-center">
					<img src="@(Model.User.AvatarUrl ?? "/images/none.png")" class="rounded-circle img-thumbnail"
						style="width: 120px; height: 120px; object-fit: cover;" alt="@Model.User.Username">
				</div>
				<div class="col-md-7">
					<h2 class="mb-1">@Model.User.Username</h2>
					<p class="text-muted mb-2">Üye olma tarihi: @Model.User.CreatedAt.ToString("MMMM yyyy")</p>
					<p class="lead fs-6">@(Model.User.Bio ?? "Henüz bir biyografi eklenmemiş.")</p>

					<div class="d-flex gap-4 mt-3">
						<div class="text-center">
							<span class="fw-bold d-block fs-5">@Model.FollowersCount</span>
							<small class="text-muted">Takipçi</small>
						</div>
						<div class="text-center">
							<span class="fw-bold d-block fs-5">@Model.FollowingCount</span>
							<small class="text-muted">Takip</small>
						</div>
					</div>
				</div>
				<div class="col-md-3 text-end">
					@if (Model.IsOwner)
					{
						<button class="btn btn-outline-primary mb-2 w-100" data-bs-toggle="modal"
							data-bs-target="#editProfileModal">
							<i class="bi bi-pencil"></i> Profili Düzenle
						</button>
						<button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#createListModal">
							<i class="bi bi-plus-lg"></i> Yeni Liste Oluştur
						</button>
					}
					else
					{
						@if (Model.IsFollowing)
						{
							<form asp-action="Unfollow" asp-route-id="@Model.User.Id" method="post">
								<button type="submit" class="btn btn-outline-danger w-100">
									<i class="bi bi-person-dash"></i> Takipten Çık
								</button>
							</form>
						}
						else
						{
							<form asp-action="Follow" asp-route-id="@Model.User.Id" method="post">
								<button type="submit" class="btn btn-primary w-100">
									<i class="bi bi-person-plus"></i> Takip Et
								</button>
							</form>
						}
					}
				</div>
			</div>
		</div>
	</div>

	<ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
		<li class="nav-item">
			<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#library">
				<i class="bi bi-collection-play me-1"></i> Kütüphanem
			</button>
		</li>
		<li class="nav-item">
			<button class="nav-link" data-bs-toggle="tab" data-bs-target="#lists">
				<i class="bi bi-list-stars me-1"></i> Özel Listeler
			</button>
		</li>
		<li class="nav-item">
			<button class="nav-link" data-bs-toggle="tab" data-bs-target="#activity">
				<i class="bi bi-activity me-1"></i> Son Aktiviteler
			</button>
		</li>
	</ul>

	<div class="tab-content" id="profileTabsContent">

		<div class="tab-pane fade show active" id="library">
			<div class="row">
				<div class="col-md-3 mb-3">
					<div class="list-group" id="library-list-tab" role="tablist">
						<a class="list-group-item list-group-item-action active" data-bs-toggle="list"
							href="#lib-watched">İzlediklerim (@Model.WatchedMovies.Count)</a>
						<a class="list-group-item list-group-item-action" data-bs-toggle="list"
							href="#lib-watchlist">İzlenecekler (@Model.WatchlistMovies.Count)</a>
						<a class="list-group-item list-group-item-action" data-bs-toggle="list"
							href="#lib-read">Okuduklarım (@Model.ReadBooks.Count)</a>
						<a class="list-group-item list-group-item-action" data-bs-toggle="list"
							href="#lib-reading">Okunacaklar (@Model.ReadingListBooks.Count)</a>
					</div>
				</div>

				<div class="col-md-9">
					<div class="tab-content">
						<div class="tab-pane fade show active" id="lib-watched">
							@await Html.PartialAsync("_ContentGrid", Model.WatchedMovies)
						</div>
						<div class="tab-pane fade" id="lib-watchlist">
							@await Html.PartialAsync("_ContentGrid", Model.WatchlistMovies)
						</div>
						<div class="tab-pane fade" id="lib-read">
							@await Html.PartialAsync("_ContentGrid", Model.ReadBooks)
						</div>
						<div class="tab-pane fade" id="lib-reading">
							@await Html.PartialAsync("_ContentGrid", Model.ReadingListBooks)
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="lists">
			@if (Model.CustomLists.Any())
			{
				<div class="row">
					@foreach (var list in Model.CustomLists)
					{
						<div class="col-md-4 mb-3">
							<div class="card h-100">
								<div class="card-body">
									<h5 class="card-title">@list.Name</h5>
									<p class="card-text text-muted">@list.Description</p>
									<p class="card-text"><small>@(list.Contents?.Count ?? 0) içerik</small></p>
									<button class="btn btn-sm btn-outline-primary" onclick="showListContents(@list.Id)">
										<i class="bi bi-eye"></i> Listeyi Gör
									</button>
								</div>
							</div>
						</div>
					}
				</div>
			}
			else
			{
				<div class="alert alert-light text-center">Henüz özel bir liste yok.</div>
			}
		</div>

		<div class="tab-pane fade" id="activity">
			@if (Model.RecentActivities.Any())
			{
				<div class="list-group">
					@foreach (var act in Model.RecentActivities)
					{
						<div class="list-group-item">
							<div class="d-flex w-100 justify-content-between">
								<h6 class="mb-1">
									<span class="badge bg-secondary">@act.ActionType</span>
									@act.TargetTitle
								</h6>
								<small class="text-muted">@act.CreatedAt.ToString("g")</small>
							</div>
							<small>@act.Username bir işlem gerçekleştirdi.</small>
						</div>
					}
				</div>
			}
			else
			{
				<div class="alert alert-light text-center">Son aktivite bulunamadı.</div>
			}
		</div>
	</div>
</div>

@if (Model.IsOwner)
{
	<div class="modal fade" id="createListModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Yeni Liste Oluştur</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="createListForm">
						<div class="mb-3">
							<label class="form-label">Liste Adı</label>
							<input type="text" class="form-control" id="listName" required
								placeholder="Örn: En İyi Korku Filmleri">
						</div>
						<div class="mb-3">
							<label class="form-label">Açıklama</label>
							<textarea class="form-control" id="listDesc" rows="3"
							placeholder="Bu listenin amacı ne?"></textarea>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
					<button type="button" class="btn btn-primary" onclick="submitCreateList()">Oluştur</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="editProfileModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<form asp-action="UpdateProfile" method="post">
					<div class="modal-header">
						<h5 class="modal-title">Profili Düzenle</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<label class="form-label">Avatar URL</label>
							<input type="text" class="form-control" name="avatarUrl" value="@Model.User.AvatarUrl">
						</div>
						<div class="mb-3">
							<label class="form-label">Biyografi</label>
							<textarea class="form-control" name="bio" rows="3">@Model.User.Bio</textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
						<button type="submit" class="btn btn-primary">Kaydet</button>
					</div>
				</form>
			</div>
		</div>
	</div>
}

<div class="modal fade" id="listDetailModal" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<div>
					<h5 class="modal-title" id="detailModalTitle">Liste Adı</h5>
					<small class="text-muted" id="detailModalDesc">Açıklama</small>
				</div>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div id="detailLoading" class="text-center py-4">
					<div class="spinner-border text-primary" role="status"></div>
				</div>

				<div id="listContentsContainer" class="row row-cols-2 row-cols-md-3 g-3"></div>

				<div id="detailEmpty" class="alert alert-info text-center" style="display:none;">
					Bu listede henüz içerik yok.
				</div>
			</div>
		</div>
	</div>
</div>

<script>

	function showListContents(listId) {
		// Modalı aç
		var modal = new bootstrap.Modal(document.getElementById('listDetailModal'));
		modal.show();

		// Yükleniyor durumuna getir
		document.getElementById('detailLoading').style.display = 'block';
		document.getElementById('listContentsContainer').innerHTML = '';
		document.getElementById('detailEmpty').style.display = 'none';
		document.getElementById('detailModalTitle').innerText = 'Yükleniyor...';
		document.getElementById('detailModalDesc').innerText = '';

		// Veriyi çek
		fetch('/UserList/GetListDetails/' + listId)
			.then(res => res.json())
			.then(response => {
				document.getElementById('detailLoading').style.display = 'none';

				if (!response.success) {
					alert(response.message);
					modal.hide();
					return;
				}

				var list = response.data;
				document.getElementById('detailModalTitle').innerText = list.name;
				document.getElementById('detailModalDesc').innerText = list.description || '';

				// İçerik yoksa uyarı göster
				if (!list.contents || list.contents.length === 0) {
					document.getElementById('detailEmpty').style.display = 'block';
					return;
				}

				// İçerikleri listele
				var container = document.getElementById('listContentsContainer');
				list.contents.forEach(item => {
					var cardHtml = `
                            <div class="col">
                                <div class="card h-100 shadow-sm">
                                    <img src="${item.coverUrl || '/images/placeholder.jpg'}" class="card-img-top" 
                                         style="aspect-ratio: 2/3; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-truncate small mb-1" title="${item.title}">${item.title}</h6>
                                        <a href="/Content/Detail?type=${item.contentType}&id=${item.id}" 
                                           class="btn btn-xs btn-outline-secondary w-100 stretched-link">Detay</a>
                                    </div>
                                </div>
                            </div>
                        `;
					container.innerHTML += cardHtml;
				});
			})
			.catch(err => {
				console.error(err);
				alert("Liste detayları yüklenirken bir hata oluştu.");
			});
	}
		
	function submitCreateList() {
		var name = document.getElementById('listName').value;
		var desc = document.getElementById('listDesc').value;

		if (!name) { alert("Lütfen bir isim girin."); return; }

		var formData = new FormData();
		formData.append('name', name);
		formData.append('description', desc);

		fetch('/UserList/Create', {
			method: 'POST',
			body: formData
		})
			.then(res => res.json())
			.then(data => {
				alert(data.message);
				if (data.success) location.reload(); // Sayfayı yenile ki yeni liste görünsün
			});
	}
</script>