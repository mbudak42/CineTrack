@model List<ActivityDto>
@using CineTrack.Shared.DTOs

@{
	ViewData["Title"] = "Ana Sayfa";
}

<div class="container py-4">

	@if (Context.Session.GetString("token") == null)
	{
		<div class="text-center py-5">
			<h1 class="display-4 fw-bold mb-3">ðŸŽ¬ CineTrack</h1>
			<p class="lead text-muted mb-4">Filmleri ve kitaplarÄ± keÅŸfet, topluluÄŸun ne dÃ¼ÅŸÃ¼ndÃ¼ÄŸÃ¼nÃ¼ gÃ¶r.</p>
			<div class="d-flex justify-content-center gap-3">
				<a asp-controller="Auth" asp-action="Login" class="btn btn-primary btn-lg px-4 shadow-sm">GiriÅŸ Yap</a>
				<a asp-controller="Auth" asp-action="Register" class="btn btn-outline-dark btn-lg px-4 shadow-sm">KayÄ±t
					Ol</a>
			</div>
		</div>
	}
	else
	{
		<div class="row justify-content-center">
			<div class="col-lg-7 col-md-9">
				<h4 class="mb-4 fw-bold text-secondary">Topluluk AkÄ±ÅŸÄ±</h4>

				@if (Model == null || !Model.Any())
				{
					<div class="text-center py-5 bg-white rounded-3 shadow-sm">
						<div class="fs-1 mb-3">ðŸ˜´</div>
						<h3>HenÃ¼z hareket yok</h3>
						<p class="text-muted">Toplulukta henÃ¼z bir aktivite gerÃ§ekleÅŸmemiÅŸ.</p>
						<a asp-controller="Search" asp-action="Index" class="btn btn-outline-primary mt-2">Ä°lk Ä°Ã§eriÄŸi Sen
							Puanla</a>
					</div>
				}
				else
				{
					<div class="d-flex flex-column gap-4">
						@foreach (var item in Model)
						{
							<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
								<div class="card-header bg-white border-0 p-3 d-flex align-items-center gap-3">
									<a asp-controller="User" asp-action="Profile" asp-route-id="@item.UserId"
										class="text-decoration-none">
										<img src="@(item.UserAvatar ?? "/images/none.png")" alt="@item.Username"
											class="rounded-circle border" style="width: 45px; height: 45px; object-fit: cover;">
									</a>
									<div class="d-flex flex-column">
										<div class="fw-bold text-dark">
											<a asp-controller="User" asp-action="Profile" asp-route-id="@item.UserId"
												class="text-dark text-decoration-none">
												@item.Username
											</a>
											<span class="fw-normal text-muted ms-1">
												@(item.ActionType == "rating" ? "puanladÄ±" : "inceledi")
											</span>
										</div>
										<small class="text-muted" style="font-size: 0.8rem;">
											@item.CreatedAt.ToString("dd MMMM HH:mm")
										</small>
									</div>

									@if (item.RatingValue.HasValue && item.RatingValue > 0)
									{
										<div
											class="ms-auto bg-warning text-dark px-2 py-1 rounded-3 fw-bold d-flex align-items-center gap-1">
											<i class="bi bi-star-fill small"></i>
											<span>@item.RatingValue</span>
										</div>
									}
								</div>

								<div class="card-body p-3 pt-0">
									<div class="d-flex gap-3">
										<a asp-controller="Content" asp-action="Detail" asp-route-type="@item.ContentType"
											asp-route-id="@item.TargetId" class="flex-shrink-0">
											<img src="@(item.CoverUrl ?? "/images/placeholder.jpg")" class="rounded-3 shadow-sm"
												alt="@item.TargetTitle" style="width: 100px; aspect-ratio: 2/3; object-fit: cover;">
										</a>

										<div class="flex-grow-1">
											<h5 class="fw-bold mb-1">
												<a asp-controller="Content" asp-action="Detail" asp-route-type="@item.ContentType"
													asp-route-id="@item.TargetId" class="text-dark text-decoration-none">
													@item.TargetTitle
												</a>
											</h5>
											<div class="mb-2">
												<span
													class="badge @(item.ContentType == "movie" ? "bg-danger" : "bg-info") bg-opacity-75">
													@(item.ContentType == "movie" ? "Film" : "Kitap")
												</span>
											</div>

											@if (!string.IsNullOrEmpty(item.ReviewText))
											{
												<div class="bg-light p-3 rounded-3 position-relative mt-2">
													<i
														class="bi bi-quote position-absolute top-0 start-0 ms-2 mt-1 text-secondary opacity-25 fs-3"></i>
													<p class="mb-0 text-dark small fst-italic ps-3 py-1" style="line-height: 1.5;">
														@item.ReviewText
													</p>
												</div>
											}
										</div>
									</div>
								</div>

								<div class="card-footer bg-white border-top p-2 d-flex justify-content-between align-items-center">
									<button class="btn btn-sm btn-light @(item.IsLiked ? "text-danger" : "text-muted")"
										onclick="toggleLike(this, @item.Id)">
										<i class="bi @(item.IsLiked ? "bi-heart-fill" : "bi-heart") me-1"></i>
										<span>@item.LikeCount</span> BeÄŸeni
									</button>

									<button class="btn btn-sm btn-light text-primary" onclick="openCommentsModal(@item.Id)">
										<i class="bi bi-chat-dots me-1"></i>
										<span>@item.CommentCount</span> Yorum
									</button>

									<a asp-controller="Content" asp-action="Detail" asp-route-type="@item.ContentType"
										asp-route-id="@item.TargetId" class="btn btn-sm btn-light text-secondary">
										<i class="bi bi-arrow-right-short"></i> Ä°ncele
									</a>
								</div>
							</div>
						}
					</div>
				}
			</div>
		</div>
	}

	<div class="modal fade" id="commentsModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Yorumlar</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div id="commentsList" class="d-flex flex-column gap-3">
					</div>
				</div>
				<div class="modal-footer">
					<div class="input-group">
						<input type="text" id="commentInput" class="form-control" placeholder="Yorum yaz...">
						<button class="btn btn-primary" onclick="submitComment()">GÃ¶nder</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script src="~/js/index.js"></script>
}