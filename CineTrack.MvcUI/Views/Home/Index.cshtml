@using CineTrack.Shared.DTOs
@model List<ActivityDto> // Dynamic yerine DTO kullanÄ±yoruz

@{
	ViewData["Title"] = "Ana Sayfa";
}

<div class="container">

	@if (Context.Session.GetString("token") == null)
	{
		<div class="text-center py-5">
			<h1 class="display-4 fw-bold mb-3">ðŸŽ¬ CineTrack</h1>
			<p class="lead text-muted mb-4">Filmleri ve kitaplarÄ± takip et, arkadaÅŸlarÄ±nla paylaÅŸ.</p>
			<div class="d-flex justify-content-center gap-3">
				<a asp-controller="Auth" asp-action="Login" class="btn btn-primary btn-lg px-4">GiriÅŸ Yap</a>
				<a asp-controller="Auth" asp-action="Register" class="btn btn-outline-dark btn-lg px-4">KayÄ±t Ol</a>
			</div>
		</div>
	}
	else
	{
		<div class="row justify-content-center">
			<div class="col-lg-8">

				@if (Model == null || !Model.Any())
				{
					<div class="empty-state">
						<div class="empty-icon">ðŸ˜´</div>
						<h3>HenÃ¼z hareket yok</h3>
						<p class="empty-text">AkÄ±ÅŸÄ±nÄ± canlandÄ±rmak iÃ§in arkadaÅŸlarÄ±nÄ± takip etmeye baÅŸla!</p>
						<a asp-controller="Search" asp-action="Index" class="empty-action">Ä°Ã§erik KeÅŸfet</a>
					</div>
				}
				else
				{
					<div class="feed">
						@foreach (var item in Model)
						{
							<div class="activity-card">
								<div class="card-header border-0 pb-0 bg-white">
									<div class="user-avatar">
										@if (!string.IsNullOrEmpty(item.UserAvatar))
										{
											<img src="@item.UserAvatar"
												style="width:100%; height:100%; border-radius:50%; object-fit:cover;" />
										}
										else
										{
											<span>@item.Username?.Substring(0, 1).ToUpper()</span>
										}
									</div>
									<div class="user-info">
										<div class="user-name">
											<a asp-controller="User" asp-action="Profile"
												asp-route-id="@item.UserId">@item.Username</a>
											<span class="text-muted fw-normal" style="font-size: 0.9rem">
												@if (item.ActionType == "rating")
												{
													<span>puanladÄ±</span>
												}
												else if (item.ActionType == "review")
												{

													<span>inceledi</span>
												}
												else if (item.ActionType == "list_add")
												{

													<span>listeye ekledi</span>
												}
												else
												{

													<span>bir iÅŸlem yaptÄ±</span>
												}
											</span>
										</div>
										<div class="activity-meta">@item.CreatedAt.ToString("dd MMM HH:mm")</div>
									</div>
								</div>

								<div class="card-body pt-3">

									@if (item.ActionType == "rating")
									{
										<div class="d-flex flex-column align-items-center text-center">
											<a asp-controller="Content" asp-action="Detail" asp-route-type="@item.ContentType"
												asp-route-id="@item.TargetId" class="mb-3 d-block position-relative">
												<img src="@(item.CoverUrl ?? "/images/placeholder.jpg")" class="rounded shadow-sm"
													style="width: 160px; aspect-ratio: 2/3; object-fit: cover;" alt="@item.TargetTitle">
											</a>

											<h5 class="fw-bold mb-1">@item.TargetTitle</h5>

											<div class="rating-display justify-content-center mt-2 p-2 bg-light rounded-pill px-4">
												<div class="stars text-warning">
													@for (int i = 1; i <= 5; i++)
													{
														if (i <= item.RatingValue)
														{
															<i class="bi bi-star-fill"></i>
														}
														else
														{

															<i class="bi bi-star text-black-50"></i>
														}
													}
												</div>
												<span class="rating-value ms-2 text-dark">@item.RatingValue/5</span>
											</div>
										</div>
									}

									else if (item.ActionType == "review")
									{
										<div class="activity-content">
											<a asp-controller="Content" asp-action="Detail" asp-route-type="@item.ContentType"
												asp-route-id="@item.TargetId">
												<img src="@(item.CoverUrl ?? "/images/placeholder.jpg")" class="content-poster"
													alt="@item.TargetTitle">
											</a>

											<div class="content-details">
												<h5 class="content-title">
													<a asp-controller="Content" asp-action="Detail" asp-route-type="@item.ContentType"
														asp-route-id="@item.TargetId" class="text-decoration-none text-dark">
														@item.TargetTitle
													</a>
												</h5>
												<div class="content-info">
													<i class="bi @(item.ContentType == "movie" ? "bi-film" : "bi-book")"></i>
													@(item.ContentType == "movie" ? "Film" : "Kitap")
												</div>

												@if (!string.IsNullOrEmpty(item.ReviewText))
												{
													<div class="review-excerpt position-relative">
														<i
															class="bi bi-quote fs-3 text-secondary opacity-25 position-absolute top-0 start-0 ps-2"></i>
														<p class="mb-1 fst-italic text-dark ps-3">
															@if (item.ReviewText.Length > 180)
															{
																@item.ReviewText.Substring(0, 180)
										
																<span>...</span>
															}
															else
															{
																@item.ReviewText
															}
														</p>
														@if (item.ReviewText.Length > 180)
														{
															<div class="text-end">
																<a asp-controller="Content" asp-action="Detail"
																	asp-route-type="@item.ContentType" asp-route-id="@item.TargetId"
																	class="read-more small">
																	DevamÄ±nÄ± oku <i class="bi bi-arrow-right"></i>
																</a>
															</div>
														}
													</div>
												}
											</div>
										</div>
									}

									else
									{
										<div class="activity-content">
											<img src="@(item.CoverUrl ?? "/images/placeholder.jpg")" class="content-poster"
												style="width: 60px; height: 90px;">
											<div class="ms-3 align-self-center">
												<h5 class="fw-bold mb-1">@item.TargetTitle</h5>
												<span class="badge bg-secondary">Listeye Eklendi</span>
											</div>
										</div>
									}

								</div>

								<div class="card-footer bg-white border-top-0 pt-0">
									<button class="action-btn" onclick="toggleLike(this)">
										<i class="bi bi-heart"></i> <span>0 BeÄŸeni</span>
									</button>
									<a asp-controller="Content" asp-action="Detail" asp-route-type="@item.ContentType"
										asp-route-id="@item.TargetId" class="action-btn text-decoration-none">
										<i class="bi bi-chat-bubble"></i> Yorum Yap
									</a>
									<button class="action-btn ms-auto">
										<i class="bi bi-share"></i>
									</button>
								</div>
							</div>
						}
					</div>
				}
			</div>
		</div>
	}
</div>

@section Scripts {
	<script src="~/js/index.js"></script>
}