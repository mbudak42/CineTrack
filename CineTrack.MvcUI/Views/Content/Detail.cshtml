@model ContentDetailDto

<div class="content-detail container mt-4">

	<!-- Başlık ve Kapak -->
	<div class="row">
		<div class="col-md-4">
			<img src="@(Model.CoverUrl ?? "/images/placeholder-poster.jpg")" class="img-fluid" alt="@Model.Title">
		</div>
		<div class="col-md-8">
			<h2>@Model.Title</h2>

			<!-- Meta bilgiler -->
			<ul class="list-unstyled">
				@if (Model.Year.HasValue)
				{
					<li><strong>Yıl:</strong> @Model.Year</li>
				}

				@if (Model.DurationOrPageCount.HasValue)
				{
					<li><strong>@(Model.ContentType == "movie" ? "Süre" : "Sayfa"):</strong> @Model.DurationOrPageCount
						@(Model.ContentType == "movie" ? "dk" : "sayfa")</li>
				}

				@if (Model.Genres != null && Model.Genres.Any())
				{
					<li><strong>Türler:</strong> @string.Join(", ", Model.Genres)</li>
				}

				@if (Model.ContentType == "movie" && Model.Directors != null && Model.Directors.Any())
				{
					<li><strong>Yönetmen:</strong> @string.Join(", ", Model.Directors)</li>
				}

				@if (Model.ContentType == "book" && Model.Authors != null && Model.Authors.Any())
				{
					<li><strong>Yazar:</strong> @string.Join(", ", Model.Authors)</li>
				}
			</ul>

			@if (!string.IsNullOrEmpty(Model.Overview))
			{
				<p>@Model.Overview</p>
			}

			<!-- Puan -->
			@if (Model.AverageRating.HasValue)
			{
				<p><strong>Puan:</strong> @Model.AverageRating.Value.ToString("0.0") / 10 (@Model.RatingCount oy)</p>
			}

			<!-- Kullanıcı Eylem Butonları -->
			<div class="mb-3">
				<label>Puan ver:</label>
				<input type="number" min="1" max="10" value="@(Model.AverageRating ?? 0)" id="userRating" />
				<button class="btn btn-primary btn-sm"
					onclick="submitRating('@Model.Id', '@Model.ContentType')">Gönder</button>
			</div>

			<div class="mb-3 d-grid gap-2 d-md-block">
				@if (Model.ContentType == "movie")
				{
					<button class="btn btn-success" onclick="addToList('@Model.Id', 'İzlediklerim')">
						<i class="bi bi-check-circle-fill"></i> İzledim
					</button>
					<button class="btn btn-warning" onclick="addToList('@Model.Id', 'İzlenecekler')">
						<i class="bi bi-bookmark-plus-fill"></i> İzlenecekler
					</button>
					<button class="btn btn-info" onclick="openCustomListModal()">
						<i class="bi bi-list-stars"></i> Özel Listeye Ekle
					</button>
				}
				else
				{
					<button class="btn btn-success" onclick="addToList('@Model.Id', 'Okuduklarım')">
						<i class="bi bi-check-circle-fill"></i> Okudum
					</button>
					<button class="btn btn-warning" onclick="addToList('@Model.Id', 'Okunacaklar')">
						<i class="bi bi-bookmark-plus-fill"></i> Okunacaklar
					</button>
					<button class="btn btn-info" onclick="openCustomListModal()">
						<i class="bi bi-list-stars"></i> Özel Listeye Ekle
					</button>
				}
			</div>
		</div>
	</div>

	<!-- Yorumlar -->
	<hr />
	<h4>Yorumlar (@(Model.Comments?.Count ?? 0))</h4>
	<div class="comments mb-3">
		@if (Model.Comments != null && Model.Comments.Any())
		{
			@foreach (var c in Model.Comments)
			{
				<div class="border rounded p-2 mb-2">
					<strong>@c.UserName</strong> <small class="text-muted">@c.CreatedAt.ToString("g")</small>
					<p>@c.Text</p>
				</div>
			}
		}
		else
		{
			<p>Henüz yorum yok.</p>
		}
	</div>

	<div class="mb-3">
		<textarea id="newComment" class="form-control" placeholder="Yorum yaz..."></textarea>
		<button class="btn btn-primary mt-2" onclick="submitComment('@Model.Id', '@Model.ContentType')">Gönder</button>
	</div>

	<div class="modal fade" id="addCustomListModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Özel Listeye Ekle</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div id="loadingLists" class="text-center">
						<div class="spinner-border text-primary" role="status"></div>
					</div>
					<div id="listsContainer" class="list-group">
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

<script>
	// Listeleri getir ve Modalı aç
	function openCustomListModal() {
		var modal = new bootstrap.Modal(document.getElementById('addCustomListModal'));
		modal.show();

		// Listeleri temizle ve loading göster
		document.getElementById('listsContainer').innerHTML = '';
		document.getElementById('loadingLists').style.display = 'block';

		fetch('/UserList/GetMyLists')
			.then(res => res.json())
			.then(lists => {
				document.getElementById('loadingLists').style.display = 'none';
				var container = document.getElementById('listsContainer');

				if (lists.length === 0) {
					container.innerHTML = '<div class="alert alert-warning">Henüz özel bir listeniz yok. Profilinizden oluşturabilirsiniz.</div>';
					return;
				}

				// Temel listeleri (İzlediklerim vb.) filtrele, sadece özelleri göster
				var customLists = lists.filter(l =>
					l.name !== 'İzlediklerim' &&
					l.name !== 'İzlenecekler' &&
					l.name !== 'Okuduklarım' &&
					l.name !== 'Okunacaklar'
				);

				if (customLists.length === 0) {
					container.innerHTML = '<div class="alert alert-info">Sadece varsayılan listeleriniz var. Yeni bir özel liste oluşturun.</div>';
					return;
				}

				customLists.forEach(list => {
					var btn = document.createElement('button');
					btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
					btn.innerHTML = `<span>${list.name}</span> <span class="badge bg-secondary rounded-pill">${list.contents ? list.contents.length : 0}</span>`;
					btn.onclick = function () { addToCustomList(list.id); };
					container.appendChild(btn);
				});
			});
	}

	function addToCustomList(listId) {
		var contentId = '@Model.Id';

		var formData = new FormData();
		formData.append('listId', listId);
		formData.append('contentId', contentId);

		fetch('/UserList/AddContent', {
			method: 'POST',
			body: formData
		})
			.then(res => res.json())
			.then(data => {
				alert(data.message);
				// Modalı kapat
				var modalEl = document.getElementById('addCustomListModal');
				var modal = bootstrap.Modal.getInstance(modalEl);
				modal.hide();
			});
	}

	function addToList(contentId, listName) {
		// Butona basıldığında kullanıcıya bilgi verelim (basitçe)
		// İsterseniz burada loading ikonu gösterebilirsiniz.

		const formData = new FormData();
		formData.append('contentId', contentId);
		formData.append('listName', listName);

		fetch('/Content/AddToList', {
			method: 'POST',
			body: formData
		})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					alert(data.message); // Başarılı mesajı
				} else {
					alert(data.message); // Hata mesajı
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert("Bir hata oluştu.");
			});
	}

	function submitRating(id, type) {
		var rating = document.getElementById("userRating").value;
		console.log("Rating gönder:", id, type, rating);
		// Burada Ajax ile API call yapılabilir
	}

	function submitComment(id, type) {
		var comment = document.getElementById("newComment").value;
		console.log("Comment gönder:", id, type, comment);
		// Burada Ajax ile API call yapılabilir
	}
</script>