@model ContentViewModel

<div class="content-detail container mt-4">

	<div class="row">
		<div class="col-md-4">
			<div class="position-relative">
				<img src="@(Model.CoverUrl ?? "/images/placeholder-poster.jpg")"
					class="img-fluid rounded shadow-sm w-100" alt="@Model.Title">

				<span
					class="badge position-absolute top-0 end-0 m-2 @(Model.ContentType == "movie" ? "bg-danger" : "bg-info") shadow">
					<i class="bi @(Model.ContentType == "movie" ? "bi-film" : "bi-book") me-1"></i>
					@(Model.ContentType == "movie" ? "Film" : "Kitap")
				</span>
			</div>

			@if (Model.CurrentUserRating > 0)
			{
				<div class="text-center mt-3 p-3 bg-light rounded border shadow-sm">
					<span class="text-muted small text-uppercase fw-bold">Senin Puanın</span>
					<div class="fs-1 fw-bold text-warning lh-1">
						<i class="bi bi-star-fill"></i> @Model.CurrentUserRating
					</div>
				</div>
			}
		</div>

		<div class="col-md-8">
			<div class="d-flex justify-content-between align-items-start">
				<h2 class="fw-bold mb-3">@Model.Title</h2>

				@if (Model.AverageRating.HasValue)
				{
					<div class="text-end">
						<div class="badge bg-warning text-dark fs-5 shadow-sm">
							<i class="bi bi-star-fill"></i> @Model.AverageRating.Value.ToString("0.0")
						</div>
						<div class="small text-muted mt-1">@Model.RatingCount oy</div>
					</div>
				}
			</div>

			<ul class="list-unstyled text-muted mb-4">
				@if (Model.Year.HasValue)
				{
					<li><i class="bi bi-calendar-event me-2"></i><strong>Yıl:</strong> @Model.Year</li>
				}

				@if (Model.DurationOrPageCount.HasValue)
				{
					<li>
						<i class="bi @(Model.ContentType == "movie" ? "bi-clock" : "bi-book-half") me-2"></i>
						<strong>@(Model.ContentType == "movie" ? "Süre" : "Sayfa"):</strong> @Model.DurationOrPageCount
						@(Model.ContentType == "movie" ? "dk" : "sayfa")
					</li>
				}

				@if (Model.Genres != null && Model.Genres.Any())
				{
					<li><i class="bi bi-tags me-2"></i><strong>Türler:</strong> @string.Join(", ", Model.Genres)</li>
				}

				@if (Model.ContentType == "movie" && Model.Directors != null && Model.Directors.Any())
				{
					<li><i class="bi bi-megaphone me-2"></i><strong>Yönetmen:</strong> @string.Join(", ", Model.Directors)
					</li>
				}

				@if (Model.ContentType == "book" && Model.Authors != null && Model.Authors.Any())
				{
					<li><i class="bi bi-pen me-2"></i><strong>Yazar:</strong> @string.Join(", ", Model.Authors)</li>
				}
			</ul>

			@if (!string.IsNullOrEmpty(Model.Overview))
			{
				<div class="mb-4">
					<h5 class="fw-bold border-bottom pb-2">Özet</h5>
					<p class="lead fs-6">@Model.Overview</p>
				</div>
			}

			<div class="d-flex flex-wrap gap-2 mb-4">
				@if (Model.ContentType == "movie")
				{
					<button class="btn btn-success btn-lg flex-grow-1 flex-md-grow-0" onclick="openRatingModal()">
						<i class="bi bi-check-circle-fill me-2"></i>İzledim
					</button>

					<button class="btn btn-warning flex-grow-1 flex-md-grow-0"
						onclick="addToList('@Model.Id', 'izlenecekler')">
						<i class="bi bi-bookmark-plus-fill me-2"></i>İzlenecekler
					</button>
				}
				else
				{
					<button class="btn btn-success btn-lg flex-grow-1 flex-md-grow-0" onclick="openRatingModal()">
						<i class="bi bi-check-circle-fill me-2"></i>Okudum
					</button>

					<button class="btn btn-warning flex-grow-1 flex-md-grow-0"
						onclick="addToList('@Model.Id', 'okunacaklar')">
						<i class="bi bi-bookmark-plus-fill me-2"></i>Okunacaklar
					</button>
				}

				<button class="btn btn-outline-info flex-grow-1 flex-md-grow-0" onclick="openCustomListModal()">
					<i class="bi bi-list-stars me-2"></i>Özel Listeye Ekle
				</button>

				@if (Model.CurrentUserReview != null)
				{
					<button class="btn btn-primary flex-grow-1 flex-md-grow-0" onclick="openReviewModal()">
						<i class="bi bi-pencil-square me-2"></i>Gönderini Düzenle
					</button>
				}
				else
				{
					<button class="btn btn-outline-primary flex-grow-1 flex-md-grow-0" onclick="openReviewModal()">
						<i class="bi bi-chat-left-text me-2"></i>Gönderi Paylaş
					</button>
				}
			</div>
		</div>
	</div>

	<hr class="my-5" />
	<h4 class="mb-3"><i class="bi bi-chat-left-text me-2"></i>Yorumlar (@(Model.Comments?.Count ?? 0))</h4>

	<div class="comments mb-4">
		@if (Model.Comments != null && Model.Comments.Any())
		{
			@foreach (var c in Model.Comments)
			{
				<div class="card mb-3 border-0 shadow-sm bg-light">
					<div class="card-body">
						<div class="d-flex justify-content-between">
							<strong class="text-primary">@c.UserName</strong>
							<small class="text-muted">@c.CreatedAt.ToString("g")</small>
						</div>
						<p class="mt-2 mb-0 text-dark">@c.Text</p>
					</div>
				</div>
			}
		}
		else
		{
			<div class="alert alert-secondary">Henüz yorum yapılmamış. İlk yorumu sen yap!</div>
		}
	</div>

	<div class="modal fade" id="addCustomListModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Özel Listeye Ekle</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div id="loadingLists" class="text-center py-3">
						<div class="spinner-border text-primary" role="status"></div>
					</div>
					<div id="listsContainer" class="list-group">
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header border-0 pb-0">
					<h5 class="modal-title w-100 text-center">Nasıl Buldun?</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body text-center pt-2 pb-4">
					<p class="text-muted mb-4">"@Model.Title" içeriğini puanla</p>

					<div class="star-rating d-inline-flex flex-row-reverse justify-content-center gap-2 mb-4">
						<input type="radio" id="star5" name="rating" value="5" /><label for="star5"
							title="Mükemmel (5)"><i class="bi bi-star-fill"></i></label>
						<input type="radio" id="star4" name="rating" value="4" /><label for="star4"
							title="Çok İyi (4)"><i class="bi bi-star-fill"></i></label>
						<input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="İyi (3)"><i
								class="bi bi-star-fill"></i></label>
						<input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="Orta (2)"><i
								class="bi bi-star-fill"></i></label>
						<input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="Kötü (1)"><i
								class="bi bi-star-fill"></i></label>
					</div>

					<div class="d-grid px-4">
						<button type="button" class="btn btn-primary btn-lg" onclick="submitRatingWithList()">
							<i class="bi bi-check-lg me-1"></i>Kaydet ve Listeme Ekle
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="reviewModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						@(Model.CurrentUserReview != null ? "Gönderini Düzenle" : "Düşüncelerini Paylaş")
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="reviewForm">
						<div class="mb-3">
							<textarea class="form-control" id="modalReviewText" rows="5"
								placeholder="Bu içerik hakkında ne düşünüyorsun? Spoiler vermemeye çalış :)">@Model.CurrentUserReview</textarea>
						</div>
					</form>
				</div>
				<div class="modal-footer justify-content-between">
					@if (Model.CurrentUserReview != null)
					{
						<button type="button" class="btn btn-danger" onclick="deleteReview()">
							<i class="bi bi-trash me-1"></i>Sil
						</button>
					}
					else
					{
						<div></div>
					}

					<div>
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
						<button type="button" class="btn btn-primary" onclick="submitReviewFromModal()">
							@(Model.CurrentUserReview != null ? "Güncelle" : "Paylaş")
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

<style>
	.star-rating input {
		display: none;
	}

	.star-rating label {
		font-size: 2.5rem;
		color: #e9ecef;
		/* Pasif renk */
		cursor: pointer;
		transition: color 0.2s, transform 0.1s;
	}

	.star-rating label:hover {
		transform: scale(1.1);
	}

	/* Hover ve Checked durumları (flex-row-reverse sayesinde sağdan sola çalışır) */
	.star-rating input:checked~label,
	.star-rating label:hover,
	.star-rating label:hover~label {
		color: #ffc107;
		/* Sarı renk */
	}
</style>

<script>
	// --- YENİ FONKSİYONLAR ---

	// Puanlama Modalını Aç
	function openRatingModal() {
		var modal = new bootstrap.Modal(document.getElementById('ratingModal'));

		// Eğer kullanıcı daha önce puan vermişse o puanı seçili getir
		var currentRating = @(Model.CurrentUserRating);
		if (currentRating > 0) {
			var radio = document.getElementById('star' + currentRating);
			if (radio) radio.checked = true;
		}

		modal.show();
	}

	// Puanı Gönder ve Listeye Ekle
	function submitRatingWithList() {
		var ratingInput = document.querySelector('input[name="rating"]:checked');
		if (!ratingInput) {
			alert("Lütfen en az 1 yıldız seçin.");
			return;
		}

		var ratingValue = ratingInput.value;
		var contentId = '@Model.Id';
		// İçerik türüne göre varsayılan listeyi belirle
		var listName = '@(Model.ContentType == "movie" ? "izlediklerim" : "okuduklarim")';

		// 1. Puanı API'ye Gönder
		var formData = new FormData();
		formData.append('contentId', contentId);
		formData.append('rating', ratingValue);

		fetch('/Content/RateContent', {
			method: 'POST',
			body: formData
		})
			.then(res => res.json())
			.then(data => {
				if (data.success) {
					// 2. Başarılıysa Listeye Ekle (Mevcut fonksiyonu kullanıyoruz)
					// Bu fonksiyon arkada fetch atar, kullanıcıya alert gösterir.
					// Kullanıcı deneyimini kesmemek için alert'i bastırabilir veya
					// addToList fonksiyonunu biraz modifiye edebiliriz.
					// Şimdilik standart akışta çağırıyoruz:

					// Listeye ekleme işlemi (Arka planda)
					var listData = new FormData();
					listData.append('contentId', contentId);
					listData.append('listName', listName);

					fetch('/Content/AddToList', { method: 'POST', body: listData })
						.then(() => {
							// Her şey bitti, sayfayı yenile ki yeni puan görünsün
							location.reload();
						});

				} else {
					alert(data.message);
				}
			})
			.catch(err => {
				console.error(err);
				alert("Bir hata oluştu.");
			});
	}

	// --- MEVCUT FONKSİYONLAR ---

	function openCustomListModal() {
		var modal = new bootstrap.Modal(document.getElementById('addCustomListModal'));
		modal.show();

		document.getElementById('listsContainer').innerHTML = '';
		document.getElementById('loadingLists').style.display = 'block';

		fetch('/UserList/GetMyLists')
			.then(res => res.json())
			.then(lists => {
				document.getElementById('loadingLists').style.display = 'none';
				var container = document.getElementById('listsContainer');

				if (lists.length === 0) {
					container.innerHTML = '<div class="alert alert-warning">Henüz özel bir listeniz yok. Profilinizden oluşturabilirsiniz.</div>';
					return;
				}

				var customLists = lists.filter(l =>
					l.name !== 'izlediklerim' &&
					l.name !== 'izlenecekler' &&
					l.name !== 'okuduklarim' &&
					l.name !== 'okunacaklar'
				);

				if (customLists.length === 0) {
					container.innerHTML = '<div class="alert alert-info">Sadece varsayılan listeleriniz var. Yeni bir özel liste oluşturun.</div>';
					return;
				}

				customLists.forEach(list => {
					var btn = document.createElement('button');
					btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
					btn.innerHTML = `<span>${list.name}</span> <span class="badge bg-secondary rounded-pill">${list.contents ? list.contents.length : 0}</span>`;
					btn.onclick = function () { addToCustomList(list.id); };
					container.appendChild(btn);
				});
			});
	}

	function addToCustomList(listId) {
		var contentId = '@Model.Id';
		var formData = new FormData();
		formData.append('listId', listId);
		formData.append('contentId', contentId);

		fetch('/UserList/AddContent', {
			method: 'POST',
			body: formData
		})
			.then(res => res.json())
			.then(data => {
				alert(data.message);
				var modalEl = document.getElementById('addCustomListModal');
				var modal = bootstrap.Modal.getInstance(modalEl);
				modal.hide();
			});
	}

	function addToList(contentId, listName) {
		const formData = new FormData();
		formData.append('contentId', contentId);
		formData.append('listName', listName);

		fetch('/Content/AddToList', {
			method: 'POST',
			body: formData
		})
			.then(response => response.json())
			.then(data => {
				// Eğer manuel butonla tıklandıysa (modal dışı) alert göster
				// Modal içinden çağrıldığında location.reload olacağı için bu alert görünmeyebilir
				alert(data.message);
			})
			.catch(error => {
				console.error('Error:', error);
				alert("Bir hata oluştu.");
			});
	}

	function submitComment(id, type) {
		var commentText = document.getElementById("newComment").value;
		if (!commentText) {
			alert("Lütfen bir yorum yazın.");
			return;
		}

		var formData = new FormData();
		formData.append('contentId', id);
		formData.append('text', commentText);

		fetch('/Content/AddComment', {
			method: 'POST',
			body: formData
		})
			.then(res => res.json())
			.then(data => {
				if (data.success) {
					// Başarılıysa sayfayı yenile ki yeni yorum ve aktivite görünsün
					location.reload();
				} else {
					alert(data.message);
				}
			})
			.catch(err => {
				console.error(err);
				alert("Bir hata oluştu.");
			});
	}

	// Modal'ı aç
	function openReviewModal() {
		var modal = new bootstrap.Modal(document.getElementById('reviewModal'));
		modal.show();
	}

	// Yorum Gönder / Güncelle
	function submitReviewFromModal() {
		var text = document.getElementById("modalReviewText").value;
		var contentId = '@Model.Id';

		if (!text.trim()) {
			alert("Lütfen bir şeyler yazın.");
			return;
		}

		var formData = new FormData();
		formData.append('contentId', contentId);
		formData.append('text', text);

		fetch('/Content/AddComment', { // Mevcut AddComment metodu hem ekleme hem güncelleme yapıyor
			method: 'POST',
			body: formData
		})
			.then(res => res.json())
			.then(data => {
				if (data.success) {
					location.reload();
				} else {
					alert(data.message);
				}
			})
			.catch(err => console.error(err));
	}

	// Yorum Sil
	function deleteReview() {
		if (!confirm("Yorumunuzu silmek istediğinize emin misiniz?")) return;

		var formData = new FormData();
		formData.append('contentId', '@Model.Id');

		fetch('/Content/DeleteReview', {
			method: 'POST',
			body: formData
		})
			.then(res => res.json())
			.then(data => {
				if (data.success) {
					location.reload();
				} else {
					alert(data.message);
				}
			});
	}
</script>