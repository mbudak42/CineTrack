@model SearchViewModel
@{
	ViewData["Title"] = "Ara ve Keşfet";
	ViewData["FluidLayout"] = true; // Tam ekran genişliği için
}

<div class="px-3 px-lg-4 py-3">

	<form method="get" asp-action="Index" id="searchForm"
		class="d-flex align-items-center flex-wrap gap-2 p-3 border rounded shadow-sm bg-white">

		<span class="fw-bold text-nowrap text-secondary small">Filtrele:</span>

		<select class="form-select form-select-sm w-auto border-light fw-bold bg-light" name="contentType">
			<option value="movie" selected="@(Model.ContentType == "movie")">Film</option>
			<option value="book" selected="@(Model.ContentType == "book")">Kitap</option>
		</select>

		<select class="form-select form-select-sm w-auto border-light bg-light text-secondary" name="genre">
			<option value="">Kategori</option>
			@foreach (var genre in Model.AvailableGenres)
			{
				<option value="@genre" selected="@(Model.Genre == genre)">@genre</option>
			}
		</select>

		<select class="form-select form-select-sm w-auto border-light bg-light text-secondary" name="year">
			<option value="">Yıl</option>
			<option value="2025" selected='@(Model.Year == "2025")'>2025</option>
			<option value="2024" selected='@(Model.Year == "2024")'>2024</option>
			<option value="2023" selected='@(Model.Year == "2023")'>2023</option>
			<option value="2010-2020" selected='@(Model.Year == "2010-2020")'>2010-2020</option>
			<option value="2000-2010" selected='@(Model.Year == "2000-2010")'>2000-2010</option>
			<option value="1990-2000" selected='@(Model.Year == "1990-2000")'>1990-2000</option>
		</select>

		<select class="form-select form-select-sm w-auto border-light bg-light text-secondary" name="minRating">
			<option value="">Puan</option>
			<option value="9" selected="@(Model.MinRating == 9)">9+</option>
			<option value="8" selected="@(Model.MinRating == 8)">8+</option>
			<option value="7" selected="@(Model.MinRating == 7)">7+</option>
		</select>

		<a href="@Url.Action("Index")" class="btn btn-sm btn-light text-secondary border-0" title="Filtreleri Sıfırla">
			<i class="bi bi-arrow-counterclockwise"></i>
		</a>


		<div class="d-flex align-items-center gap-2 ms-auto">
			<div class="d-flex align-items-center gap-2 ms-auto">
				<span class="fw-bold text-nowrap text-secondary small">
					@(Model.ContentType == "book" ? "Kitap Ara:" : "Film Ara:")
				</span>

				<div class="input-group input-group-sm" style="width: 280px; max-width: 100%;">
					<input type="text" class="form-control border-light bg-light" name="query" value="@Model.Query"
						placeholder="İsim giriniz..." id="searchInput">

					<button class="btn btn-primary" type="submit" title="Ara">
						<i class="bi bi-search"></i>
					</button>
				</div>
			</div>
		</div>

		<button type="submit" style="display: none;"></button>
	</form>

	@if (ViewBag.Error != null)
	{
		<div class="alert alert-danger">@ViewBag.Error</div>
	}

	@if (!string.IsNullOrWhiteSpace(Model.Query))
	{
		<div class="results-section mt-4">
			<h5 class="mb-3">Sonuçlar</h5>

			<div id="searchResultsContainer" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-3">
				@* İlk sayfa *@
				@await Html.PartialAsync("_ContentCardList", Model.SearchResults)
			</div>

			@if (Model.SearchResults.Count >= 18)
			{
				<div class="text-center mt-5">
					<button id="loadMoreSearchBtn" class="btn btn-outline-primary px-5" onclick="loadMoreResults()">
						Daha Fazla Yükle
					</button>
				</div>
			}
		</div>
	}
	else
	{
		@if (Model.TopRated.Any())
		{
			<section class="mb-5 mt-4">
				<h5 class="mb-3 border-bottom pb-2">En Yüksek Puanlılar</h5>
				<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-3">
					@foreach (var content in Model.TopRated)
					{
						<div class="col">@await Html.PartialAsync("_ContentCard", content)</div>
					}
				</div>
			</section>
		}
		@if (Model.MostPopular.Any())
		{
			<section class="mb-5">
				<h5 class="mb-3 border-bottom pb-2">En Popülerler</h5>
				<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-3">
					@foreach (var content in Model.MostPopular)
					{
						<div class="col">@await Html.PartialAsync("_ContentCard", content)</div>
					}
				</div>
			</section>
		}
	}
</div>

@section Scripts {
	<script>
		document.getElementById('searchInput').addEventListener('keypress', function (e) {
			if (e.key === 'Enter') {
				e.preventDefault();
				document.getElementById('searchForm').submit();
			}
		});

		let searchPage = 1;

		function loadMoreResults() {
			const btn = document.getElementById('loadMoreSearchBtn');
			btn.disabled = true;
			btn.innerText = 'Yükleniyor...';

			searchPage++;

			// URL'den mevcut filtreleri al
			const params = new URLSearchParams(window.location.search);
			const query = params.get('query') || '';
			const type = document.querySelector('select[name="contentType"]').value;
			const genre = document.querySelector('select[name="genre"]').value;
			const year = document.querySelector('select[name="year"]').value;
			const minRating = document.querySelector('select[name="minRating"]').value;

			// LoadMore action'ına istek at
			const url = `/Search/LoadMoreSearch?query=${query}&contentType=${type}&genre=${genre}&year=${year}&minRating=${minRating}&page=${searchPage}`;

			fetch(url)
				.then(res => {
					if (res.status === 204) {
						btn.style.display = 'none'; // Veri bitti
						return null;
					}
					return res.text();
				})
				.then(html => {
					if (html) {
						document.getElementById('searchResultsContainer').insertAdjacentHTML('beforeend', html);
						btn.disabled = false;
						btn.innerText = 'Daha Fazla Yükle';
					}
				})
				.catch(err => {
					console.error(err);
					btn.innerText = 'Hata';
				});
		}
	</script>
}